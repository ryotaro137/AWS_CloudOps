# 勉強日記

## 日付
2026年02月23日

## 学習内容
- 詳細モニタリングの有効化でスケーリングを早める。
- CloudFormationのドリフト検出で設定と現在のリソース状態の差を検出する。
- ライフサイクルフックの使用でEC2の起動前/停止前にスクリプトを実行する。
- CloudWatchの機密データ検出で機密データを検出する。
- VPCピアリングはVPC間の通信のみ（オンプレミスと混同しないように。
- Compute Optimizerのデフォルト分析期間は14日間（最大93日間）

## クロスアカウント
- **AWSクロスアカウントアクセス**:
    - IAMロール（AssumeRole）を使用して、別アカウントのリソースに安全にアクセスする仕組み。
    - 信頼ポリシー（どの帳合を信じるか）と権限ポリシー（何ができるか）の2通りの設定が必要。
    - リソースベースポリシー（S3等）を使うと、ロール切り替えなしで直接アクセスを許可できる。
    - KMSで暗号化されたデータを別アカウントで解読するには、別アカウントでKMSキーを生成する必要がある。

## OpenID Connect (OIDC)
- **OIDCの概要**:
    - OAuth 2.0をベースにした「本人確認（認証）」のためのプロトコル。
    - パスワードを共有せずに、外部の信頼できるIDプロバイダー（Google等）を使ってログインできる。
- **AWSでの利用**:
    - **IAM IDプロバイダー**として設定することで、外部アプリやGitHub Actions等に一時的な権限を付与できる。
    - アクセスキー（長期クレデンシャル）を外部に保存する必要がなくなるため、セキュリティが向上する。

## ECSのデプロイ戦略
- **ローリングアップデート**:
    - デフォルト設定。古いタスクを段階的に新しいタスクへ入れ替える。
    - `minimumHealthyPercent` と `maximumPercent` で更新中のタスク数を制御。
- **ブルー/グリーンデプロイ**:
    - CodeDeployを使用。新しい環境を別に作ってトラフィックを切り替える。
    - ロールバックが容易で、本番切り替え前にテストが可能。
- **強制デプロイ**:
    - 同じイメージタグ（latest等）で中身だけ書き換えた場合、「新しいデプロイの強制」をONにする必要がある。

## AWS Systems Manager OpsCenter (OpsItem)
- **OpsItemの概要**:
    - 運用上の問題（イベント、アラート、エラー）を管理するための作業項目。
    - CloudWatchやSecurity Hubなどの様々なサービスからの通知を「対応が必要な課題」として集約する。
- **特徴**:
    - 関連するリソース情報やログに素早くアクセスできる。
    - SSM Automation（ランブック）と連携し、修正作業を自動化・簡略化できる。
    - 複数のAWSアカウントにまたがる運用課題を1箇所で管理可能。

## SSM Patch Manager (パッチ処理)
- **パッチ処理の概要**:
    - インスタンス（EC2やオンプレ）のOS・ソフトの更新プログラムを自動適用する仕組み。
- **主要コンポーネント**:
    - **パッチベースライン**: どのパッチをいつ承認して適用するかというルール。
    - **パッチグループ**: インスタンスのタグを利用して、環境ごとに適用ルールを分ける仕組み。
    - **メンテナンスウィンドウ**: パッチ適用を実行するスケジュール（時間枠）。
- **メリット**: 数百台のサーバーに対して、一貫したセキュリティレベルを自動的に維持できる。

## Amazon RDS Performance Insights
- **概要**:
    - データベースのパフォーマンス負荷を可視化するツール。
    - 負荷の原因（CPU、I/O、ロック待ちなど）と、重いSQL（Top SQL）を特定できる。
- **ポイント**:
    - **平均アクティブセッション (AAS)** を指標として、CPU性能を超えた負荷がないかを確認する。
    - 7日間のデータ保持は無料で、DBへの負荷も低いため、本番環境でも有効化が推奨される。
- **活用シーン**:
    - 「DBが重いけれど、原因がCPUなのかクエリなのか分からない」といった調査の際に、コンソールから即座に要因を特定できる。

## SSM Patch Manager vs CloudTrail
- **SSM Patch Manager**:
    - 「**OS内部の状態**」を管理。パッチを当てて脆弱性を修正する「攻め」の運用ツール。
- **CloudTrail**:
    - 「**AWSに対する操作履歴**」を記録。「誰が何をしたか」を後から追跡する「守り」の監査ツール。
- **ポイント**:
    - 片方は「メンテナンス（更新）」、もう片方は「ログ（証跡）」という役割の違いがある。

## SES vs SNS vs SQS
- **Amazon SES**: 人への「メール送信」に特化。メルマガや事務連絡用。
- **Amazon SNS**: 「プッシュ型」の通知。1対多（Fan-out）で複数の宛先に一瞬で情報を拡散する。
- **Amazon SQS**: 「プル型」のメッセージキュー。システム間を疎結合にし、メッセージを貯めておくことで負荷を平滑化する。
- **ポイント**: 
    - SNS = 「知らせる（拡散）」
    - SQS = 「貯める（待機）」
    - SES = 「メールする」

## Route 53 Resolver DNS Firewall
- **概要**: VPC内からのアウトバウンドDNSクエリを監視・フィルタリングする機能。
- **ポイント**: 
    - 悪意のあるドメインへの通信を「名前ベース」でブロックできる。
    - DNSを利用したデータの外部流出（DNSトンネリング）を防ぐのに有効。

## リソースレコード
- **Aレコード**: ホスト名をIPv4アドレスに変換する基本のレコード。
- **CNAME**: ドメインの別名をつける。
- **Alias (別名レコード)**:
    - AWS固有。S3やELBのリソースにドメインを紐付ける。
    - ルートドメイン（Apex）に使用可能で、標準DNSクエリ料金が不要。


## メールのセキュリティ認証とリソースレコード
- **SPF (TXTレコード)**: 許可された送信元IPを定義。なりすまし防止。
- **DKIM (CNAME/TXTレコード)**: 電子署名で改ざん防止。Amazon SESでは提供されるCNAMEを登録するのが一般的。
- **DMARC (TXTレコード)**: 認証失敗時の振る舞い（受信拒否など）を指定。
- **MXレコード**: メールの「受け取り」用サーバーを指定。

| 手法 | レコード型 | 主な役割 |
| :--- | :--- | :--- |
| SPF | TXT | 送信元IPの正当性確認（なりすまし防止） |
| DKIM | CNAME | 署名による改ざん検知 |
| DMARC | TXT | 認証失敗時の後続アクションの指示 |

## S3のプレフィックス単位
- **プレフィックスの概要**:
    - オブジェクト名の先頭文字列（フォルダのような階層構造）。
- **パフォーマンス特性**:
    - S3はプレフィックスごとに処理性能をスケールさせる。
    - 1プレフィックスあたり **3,500 (書込) / 5,500 (読取) リクエスト/秒** をサポート。
- **具体例（パフォーマンスの分散）**:
    - `bucket/images/` という1つのプレフィックスに全画像を置くと、秒間5,500リクエストが上限。
    - `bucket/images/customer1/` と `bucket/images/customer2/` に分ければ、それぞれで5,500リクエスト（合計11,000）まで処理可能になる。
- **具体例（管理の自動化）**:
    - **ライフサイクル**: `logs/` プレフィックス配下のみ、90日後にGLACIERへ移行。
    - **イベント通知**: `uploads/` プレフィックスにファイルが置かれた時のみ、Lambdaで画像縮小処理を起動。

## Route 53 Resolver エンドポイント
- **インバウンドエンドポイント**:
    - **オンプレからAWS**の名前解決を可能にする。
    - オンプレDNSからのクエリを受け取る「入り口」。
- **アウトバウンドエンドポイント**:
    - **AWSからオンプレ**の名前解決を可能にする。
    - **転送ルール（Forwarding Rule）**とセットで使用し、特定のドメインへのクエリをオンプレ側へ投げる「出口」。
- **注意点**: 
    - VPCピアリング等とは異なり、あくまで「DNSの名前解決」を疎通させるための仕組み。

## AWS Config と SSM Automation の連携（重要）
- **概要**: 
    - 「コンプライアンスの自動是正（Automated Remediation）」を実現する鉄板の組み合わせ。
- **流れ**:
    1. **AWS Config** が非準拠リソースを検知。
    2. 設定された **SSM Automation ランブック** が自動的にキックされる。
    3. リソースが正しい状態に自動修復される。
- **ポイント**: 
    - 「最小限の運用負荷で」「自動的に是正」というキーワードが出たらこの組み合わせを疑う。
    - Lambdaでも同様のことはできるが、標準的な修復ならSSM Automation（マネージドなランブック）の方が運用負荷が低いとされる。

## Amazon EventBridge フィルタリング機能
- **概要**: イベントパターンのJSONで、ターゲットに送るイベントを細かく制御できる。
- **代表的なフィルタ**:
    - **prefix**: 前方一致（例：リソースIDの先頭固定）。
    - **anything-but**: 指定値以外（例：特定の状態以外の時に通知）。
    - **numeric**: 数値比較（例：CPU使用率が一定以上の時）。
    - **exists**: 特定のキーが存在するか。
    - **cidr**: IPアドレス範囲での判定。
- **ポイント**: 
    - ターゲット（Lambda等）側でフィルタリングするのではなく、EventBridge側で行うことで、不要な起動（コスト・負荷）を抑えるのがベストプラクティス。

## オートスケーリングの最適構成（試験対策）
- **ターゲット追跡スケーリングポリシー (Target Tracking)**:
    - 指定したメトリクス（CPU使用率など）のターゲット値を維持するようにASGが自動調整。
    - CloudWatchアラームを個別作成する必要がなく、**管理オーバーヘッドが最小**。
- **マルチリージョンの管理**:
    - **CloudFormation StackSets** を使用して、ASGとスケーリングポリシーを全リージョンに一括展開。
- **ポイント**: 
    - 「〜%を維持したい」「管理の手間を減らしたい」という要件には Target Tracking が第一候補。

## AWS CloudFormation StackSets
- **概要**: 
    - 複数のAWSアカウントおよびリージョンにわたってStackを一括管理する機能。
- **メリット**:
    - 1回の操作（管理者アカウントから実行）で数千のアカウントに展開可能。
    - **AWS Organizations** と連携し、新規アカウント追加時に自動でプロビジョニングを実行できる。
- **ポイント**: 
    - 「マルチアカウント」「マルチリージョン」「一括管理」というキーワードが出たら StackSets。
    - CloudFormation の「Stack」は単一環境、「StackSet」は複数環境用。

## AWS Systems Manager Compliance
- **概要**: 
    - パッチ適用状態や State Manager の設定が、各インスタンスで守られているかを可視化するダッシュボード。
- **チェック対象**:
    - Patch Manager のベースライン（未適用の重要なパッチの有無）。
    - State Manager のアソシエーション（意図した設定状態の維持）。
- **ポイント**: 
    - 「非準拠」のリソースを素早く特定し、修復アクションへ繋げるための入り口。
    - **Resource Data Sync** を使うと、複数アカウントのコンプライアンス情報を集約して分析できる。

## AWS Compute Optimizer (実務での活用)
- **役割**: 過去の利用実績（CPU、メモリ、ストレージ、ネットワーク）を機械学習で分析し、最適なリソース構成をレコメンドする。
- **実務のメリット**:
    - 「コスト削減（ダウンサイジング）」と「パフォーマンス不足解消（アップサイジング）」の両方にエビデンス（根拠）を与えてくれる。
    - インスタンスだけでなく、EBSボリュームやLambdaのメモリサイズについても最適化案を出してくれる。
- **構成のポイント**: 
    - メモリのデータを分析させるには、CloudWatch Agent のインストールが必要（これを忘れるとCPU/ネットワークだけの分析になり、判断が甘くなる）。

## メトリクスフィルター (CW Logs) vs イベントフィルタリング (EventBridge)
- **メトリクスフィルター**:
    - 対象: **ログ（非構造化データ）**。
    - 役割: ログから特定の文字列を検索し、その発生数を「数値（メトリクス）」に変換する。
- **EventBridge フィルタリング**:
    - 対象: **イベント（構造化データ/JSON）**。
    - 役割: リソースの状態変化などを検知し、条件に合うものだけを次のターゲット（Lambda等）へ流す。
- **ポイント**: 
    - 「ログの中に特定の単語があるか？」ならメトリクスフィルター。
    - 「リソースのステータスが変わったか？」ならEventBridge。

## SSM エージェントの役割
- **概要**: 
    - AWS Systems Manager がインスタンスをリモート管理するための常駐プログラム。
- **機能**:
    - **Run Command**: スクリプトの実行。
    - **Session Manager**: SSH不要のリモートログイン。
    - **Patch Manager**: OSアップデートの実行。
- **ポイント**: 
    - エージェント自体の稼働に加えて、**IAMロール（ManagedInstanceCore等）**と**ネットワーク疎通（SSMサービスへのアクセス）**が揃わないと「管理対象」にならない。

## CloudWatch Logs Insights（クエリ基本）
- **概要**: 
    - パイプ(`|`)でコマンドを繋ぐ独自の構文でログを高速スキャン。
- **基本コマンド**:
    - **fields**: 取得項目の選択。
    - **filter**: 条件絞り込み（`like` / `not like` / 比較演算子）。
    - **stats**: 集計関数（`count`, `sum`, `avg`）。`bin(時間)` と組み合わせることが多い。
    - **sort / limit**: 並び替えと件数指定。
- **ポイント**: 
    - ロググループを跨いだ検索が可能。
    - JSON形式のログであれば、フィールド名（例：`status`）で直接フィルタや集計ができる。

### クエリの読み方のコツ
- **データの流れ**: 
    - 上から下の順に処理される。
    - パイプ(`|`)は「〜の結果を次の処理へ渡す」という意味。
- **日本語での読み替え**: 
    - 常に項目の取得・絞り込みから始まり、集計や並べ替えで終わる。
    - 「絞り込んで」「数えて」「並べる」という動作を繋げて読む。

## CloudWatch Logs Insights（高度なクエリ）
- **概要**: 
    - パイプ(`|`)でコマンドを繋ぐ独自の構文でログを高速スキャン。
- **基本コマンド**:
    - **fields**: 取得項目の選択。
    - **filter**: 条件絞り込み（`like` / `not like` / 比較演算子）。
    - **stats**: 集計関数（`count`, `sum`, `avg`）。`bin(時間)` と組み合わせることが多い。
    - **sort / limit**: 並び替えと件数指定。
- **ポイント**: 
    - ロググループを跨いだ検索が可能。
    - JSON形式のログであれば、フィールド名（例：`status`）で直接フィルタや集計ができる。

## Amazon Aurora Serverless v2 vs プロビジョニング
- **Serverless v2**:
    - 特徴: 負荷に応じて **ACU** 単位でインスタンスサイズが動的に伸縮する。
    - メリット: スケーリングの再起動が不要（ミリ秒単位）。予測不能な負荷に強い。
- **プロビジョニング版**:
    - 特徴: インスタンスタイプを固定して運用。
    - メリット: 負荷が安定していればコスト予測がしやすく、RI（予約割引）が使える。
- **ポイント**: 
    - 「スケーリングによるダウンタイムを排除したい」「変動が激しい」なら Serverless v2。
    - 1つのクラスター内に両方を混在させる構成も可能。

## SSM Run Command の大規模実行（レート制御）
- **max-concurrency (最大同時実行数)**:
    - 役割: 同時に実行するインスタンスの数/割合を制御。
    - メリット: ターゲット側の負荷集中を抑止。
- **max-errors (最大エラー数)**:
    - 役割: エラーが一定数（または%）に達したら、残りの実行を自動停止。
    - メリット: 設定ミス等による広範囲の障害拡大を防止する「ブレーカー」機能。
- **ポイント**: 
    - 数千台の運用では「%」での指定が管理オーバーヘッドを減らせるため便利。

## ハイブリッドアクティベーション (SSM)
- **概要**: 
    - オンプレミス等の「AWS外」のサーバーを SSM の管理対象にするための仕組み。
- **構成要素**:
    - **アクティベーションコード & ID**: 外部サーバーを AWS に紐付けるための認証情報。
    - **IAM サービスロール**: 外部サーバーが AWS サービスと通信するために必要な権限。
- **ポイント**: 
    - 管理対象になると、インスタンスIDが `mi-xxxx`（Managed Instance）という形式で表示される。
    - 「AWS以外のサーバーをSSMで管理したい」という要件に対する直接の回答。

## Amazon EventBridge Pipes
- **概要**: 
    - ポイント・ツー・ポイントで「ソース」と「ターゲット」を直接繋ぐ機能。
- **特徴 (4ステップ構成)**:
    - **ソース** (SQS等) → **フィルタ** → **拡張** (Lambda等で加工) → **ターゲット** (SNS等)。
- **メリット**: 
    - サービス間の連携に必要だった「糊（のり）コード」としての Lambda が不要になる。
- **ポイント**: 
    - 「複数のサービスをシンプルかつ低コストに繋ぎたい」というサーバーレス設計で多用される。

## CloudWatch Dashboards (クロスリージョン表示)
- **概要**: 
    - 異なるAWSリージョンのメトリクスを1つのダッシュボードに集約して表示する機能。
- **メリット**:
    - リージョンを切り替える手間なく、グローバルなシステムの健康状態を一元監視できる。
    - クロスアカウント設定と併用することで、組織全体のメトリクスを1箇所で見ることが可能。
- **ポイント**: 
    - 「複数リージョンの状況を最小の運用負荷で俯瞰したい」という要件への回答。


# その他（試験関連で）
- AWS Systems Manager インベントリは範囲外
- AWS Systems Manager Change Managerは範囲外
- AWS Systems Manager State Managerは範囲外
- AWS Systems Manager Maintenance Windowsは範囲外
- AWS Systems Manager Change Calendarは範囲外
